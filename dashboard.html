{% extends "base.html" %}

{% block title %}Dashboard - LPG Monitoring System{% endblock %}

{% block content %}

{# ---- BLOCK ADMIN FROM USER DASHBOARD ---- #}
{% if current_user.is_admin %}
    <div class="alert alert-danger">
        Admin users cannot access the user dashboard.
    </div>
{% else %}

<h2>Welcome, {{ current_user.username }}!</h2>
<p class="text-muted">Dashboard Overview</p>

<div class="row">
    <!-- ================= GAS LEVEL ================= -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Current Gas Level</h4>
            </div>
            <div class="card-body text-center">

                {% if current_gas %}
                <div class="progress" style="height: 35px;">
                    <div class="progress-bar
                        {% if current_gas.level > 50 %}bg-success
                        {% elif current_gas.level > 20 %}bg-warning
                        {% else %}bg-danger{% endif %}"
                        style="width: {{ current_gas.level }}%">
                        {{ current_gas.level }}%
                    </div>
                </div>

                <p class="mt-3">
                    Last updated: {{ current_gas.timestamp }}
                </p>
                {% else %}
                <p class="text-danger">No gas data available</p>
                {% endif %}

            </div>
        </div>
    </div>

    <!-- ================= LEAKAGE STATUS ================= -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header
                {% if current_gas and current_gas.leakage %}
                    bg-danger
                {% else %}
                    bg-success
                {% endif %}
                text-white">
                <h4 class="mb-0">Gas Leakage Status</h4>
            </div>

            <div class="card-body text-center">
                {% if current_gas %}
                    {% if current_gas.leakage %}
                        <div class="alert alert-danger">
                            <h5>⚠ WARNING: Gas Leak Detected!</h5>
                            <p>Take immediate safety measures</p>
                        </div>
                    {% else %}
                        <div class="alert alert-success">
                            <h5>✅ No Leakage Detected</h5>
                            <p>Your system is safe</p>
                        </div>
                    {% endif %}
                {% else %}
                    <p>No leakage data available</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ================= LPG BOOKING ================= -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0">Book LPG Cylinder</h4>
            </div>

            <div class="card-body">
                {% if current_gas and current_gas.level <= 10 %}
                <form method="POST" action="{{ url_for('book_lpg') }}">
                    <div class="mb-3">
                        <label class="form-label">Preferred Delivery Date</label>
                        <input type="date" class="form-control" name="booking_date" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Cylinder Type</label>
                        <select class="form-select" name="cylinder_type">
                            <option value="14kg">14kg Domestic</option>
                            <option value="19kg">19kg Commercial</option>
                            <option value="5kg">5kg Portable</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        Book Now
                    </button>
                </form>
                {% else %}
                <div class="alert alert-success">
                    Gas level sufficient. No booking required.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ================= RECENT READINGS ================= -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h4 class="mb-0">Recent Gas Readings</h4>
            </div>

            <div class="card-body table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Level</th>
                            <th>Leakage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reading in gas_readings %}
                        <tr>
                            <td>{{ reading.timestamp }}</td>
                            <td>
                                <span class="badge
                                    {% if reading.level > 50 %}bg-success
                                    {% elif reading.level > 20 %}bg-warning
                                    {% else %}bg-danger{% endif %}">
                                    {{ reading.level }}%
                                </span>
                            </td>
                            <td>
                                {% if reading.leakage %}
                                    <span class="badge bg-danger">Yes</span>
                                {% else %}
                                    <span class="badge bg-success">No</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" class="text-center">
                                No readings available
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Auto-refresh dashboard every 10 seconds
    setTimeout(() => location.reload(), 10000);
</script>
{% endblock %}
